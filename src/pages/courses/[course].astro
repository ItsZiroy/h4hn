---
import ThemedImage from "../../components/ThemedImage.astro";
import ThemeToggle from "../../components/ThemeToggle.astro";
import type { Course } from "../../interfaces/course";
import type { Summary } from "../../interfaces/summary";
import Layout from "../../layouts/Layout.astro";
import fetchApi from "../../lib/strapi";
import dayjs from "dayjs";

export async function getStaticPaths() {
  const summary = await fetchApi<{ name: string }>({
    endpoint: "summary",
    wrappedByKey: "data",
  });
  const courses = await fetchApi<Course[]>({
    endpoint: "courses",
    wrappedByKey: "data",
    query: {
      populate: {
        header: true,
        semester: true,
        association: {
          populate: {
            logo: true,
            logo_dark: true,
          },
        },
        lectures: {
          populate: {
            files: true,
          },
        },
      },
    },
  });

  return courses.map((course) => ({
    params: { course: course.slug },
    props: { course, summary },
  }));
}

type Props = {
  course: Course;
  summary: Summary;
};

const { course, summary } = Astro.props;
---

<Layout>
  <div class="w-full grid grid-cols-12 grid-rows-1">
    <div class="hidden md:block md:col-span-2"></div>
    <div
      class="text-black
    dark:text-white
    col-span-10 md:col-span-8
    max-w-screen-xl
    mx-auto
    pt-4"
    >
      <a class="" href="/courses">
        <div
          class="px-4 py-2 bg-[#92C8F5] dark:bg-gray-700 rounded-lg text-black dark:text-white hover:bg-gray-300 dark:hover:bg-gray-600 transition"
        >
          ← Back to all Courses
        </div>
      </a>

      <div class="flex items-end mb-10 mt-14">
        <h1 class="text-6xl font-bold">{course.name}</h1>

        <h2 class="text-2xl ml-auto">{course.semester.name}</h2>
      </div>

      <div class="w-full flex-col items-center">
        <ThemedImage
          width={1200}
          height={500}
          image={course.header}
          alt={course.name}
          class="rounded-4xl"
        />
        <div class="text-right text-sm mt-1">Generated using Adobe Firefly</div>
      </div>
      <div>
        <table class="min-w-full border-gray-300 mt-8">
          <thead>
            <tr class="bg-[#92C8F5] border-none dark:bg-gray-700 text-left">
              <th class="py-2 px-4 rounded-tl-lg">Date</th>
              <th class="py-2 px-4">Type</th>
              <th class="py-2 px-4">Topic</th>
              <th class="py-2 px-4">Description</th>
              <th class="py-2 px-4 rounded-tr-lg">Files</th>
            </tr>
          </thead>
          <tbody>
            {
              course.lectures
                ?.sort((a, b) =>
                  dayjs(a.start).isBefore(dayjs(b.start)) ? -1 : 1
                )
                .map((lecture) => (
                  <tr class="border-b">
                    <td class="py-2 px-4 font-bold">
                      {dayjs(lecture.start).format("dd - DD.MM")}
                    </td>
                    <td class="py-2 px-4 capitalize">{lecture.type}</td>
                    <td class="py-2 px-4">{lecture.topic}</td>
                    <td class="py-2 px-4">{lecture.description}</td>
                    <td class="py-2 px-4">
                      {lecture.files &&
                      Array.isArray(lecture.files) &&
                      lecture.files.length > 0 ? (
                        <ul>
                          {lecture.files
                            .slice()
                            .sort((a, b) => a.name.localeCompare(b.name))
                            .map((file) => (
                              <li key={file.id}>
                                <a
                                  href={import.meta.env.STRAPI_URL + file.url}
                                  download
                                  class="text-[#3e71a4] dark:text-gray-500 underline"
                                  title={file.alternativeText ?? file.name}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                >
                                  {file.name}
                                </a>
                              </li>
                            ))}
                        </ul>
                      ) : (
                        <span>-</span>
                      )}
                    </td>
                  </tr>
                ))
            }
          </tbody>
        </table>

        <div class="mt-20 flex items-center pb-5">
          <div class="w-140">
            <a href={"/courses/" + course.slug} class="hover:underline"
              >{course.name}</a
            > © 2025 by <a href="https://h4hn.de/">{summary.name}</a> is licensed
            under
            <a href="https://creativecommons.org/licenses/by/4.0/"
              >Creative Commons Attribution 4.0 International<div
                class="inline-flex ml-2"
              >
                <img
                  src="https://mirrors.creativecommons.org/presskit/icons/cc.svg"
                  alt=""
                  style="max-width: 1em;max-height:1em;margin-left: .2em;"
                /><img
                  src="https://mirrors.creativecommons.org/presskit/icons/by.svg"
                  alt=""
                  style="max-width: 1em;max-height:1em;margin-left: .2em;"
                />
              </div>
            </a>
          </div>
          <div class="h-20 ml-auto">
            <ThemedImage
              inferSize={true}
              image={course.association.logo}
              imageDark={course.association.logo_dark}
              alt={course.association.name}
              class="h-full w-auto"
            />
          </div>
        </div>
      </div>
    </div>
    <div class="col-span-2 flex justify-end md:justify-center items-start mt-6">
      <ThemeToggle />
    </div>
  </div>
</Layout>
